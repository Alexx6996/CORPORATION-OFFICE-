security_checks:
  service_name: "aioffice"
  owner: "User"
  scope:
    surface:
      - fastapi / uvicorn сервис aioffice
      - observability endpoints (/healthz, /metrics)
      - Redis (очереди / шина)
      - локальные артефакты и сгенерированные данные
      - Windows-служба, которая крутит aioffice
    note: "нет сущности Director; используем только имя aioffice"

  tls:
    transport_encryption:
      - "Внешние вызовы к aioffice должны идти только по TLS. plain HTTP допустим только для локальной разработки на 127.0.0.1."
      - "mTLS (взаимная проверка сертификатов клиент-сервис) обязательна для машинного доступа между внутренними компонентами в проде."
    key_storage:
      - "Закрытые ключи и сертификаты не хранятся в git."
      - "Секреты и приватные ключи хранятся в Credential Manager / BitLocker-защищённых локациях."
    rotation:
      - "Срок действия внутренних сертификатов ограничен. Планы ротации сертификатов должны быть проверены перед релизом."
    check_before_release:
      - "Проверить, что TLS включён на внешнем интерфейсе."
      - "Проверить, что приватные ключи не попали в репозиторий."

  authentication:
    model:
      - "Все публичные/внешние точки aioffice требуют аутентификации (например токен, сессия, client cert)."
      - "Системные агенты (финансы, юрист и т.д.) аутентифицируются как сервисные аккаунты, а не как пользователь-человек."
    storage:
      - "Секреты сервисных аккаунтов не входят в git и не хранятся в открытом виде на диске."
    check_before_release:
      - "Нет ли эндпоинтов без auth, кроме /healthz (локально) и /metrics (локально/прометеус)."

  authorization:
    rbac_abac:
      rbac:
        - "Каждый агент/роль имеет явно определённые разрешения: чтение финансовых данных, запуск генерации отчётов, администрирование и т.д."
        - "Нет 'суперпользователя по умолчанию'."
      abac:
        - "Дополнительные атрибуты (чей это артефакт? какой клиент? какой домен?) используются для ограничения доступа."
      enforcement:
        - "Доступ к чувствительным данным (финансы, юрист, бухгалетрия, налоговые отчёты) проверяется в коде, не на UI уровне."
      check_before_release:
        - "Просмотреть diff и убедиться, что новые эндпоинты помечены нужными ролями/атрибутами."

  container_isolation:
    runtime:
      - "Redis и другие вспомогательные сервисы (очередь, кеш) работают в Docker-контейнере с restart=unless-stopped."
      - "Контейнеры сидят в выделенной docker-сети (например aioffice-net), закрытой от внешки."
    host_integrity:
      - "Windows-хост с BitLocker на рабочих томах."
      - "Исключения Defender настроены точечно под рабочие каталоги, но Defender не выключается полностью."
    least_privilege:
      - "Контейнеры не должны запускаться с правами Administrator / root без необходимости."
    check_before_release:
      - "Проверить docker inspect каждого контейнера на наличие привилегированных настроек."
      - "Проверить, что порты не проброшены наружу без необходимости."

  incident_response:
    key_compromise:
      - "Если скомпрометирован токен/ключ, он должен быть отозван немедленно, а не 'позже'."
      - "Все сервисные аккаунты должны поддерживать замену секрета без полной переустановки всего сервиса."
    audit_log:
      - "События безопасности и админ-доступа пишутся в централизованные логи (logs\\aioffice.log) и должны содержать trace_id."
      - "Логи не чистятся вручную; чистка логов = инцидент."
    dr_alignment:
      - "DR-план (см. backup\\dr_plan.yaml) должен обеспечивать восстановление без использования скомпрометированных ключей."

  pre_release_gate:
    required_checks:
      - "pytest -q проходит"
      - "ruff check . возвращает только некритичные замечания (не падаем на S или W высокого риска)"
      - "bandit -r . показывает 0 High severity"
      - "locust headless smoke выдержан без 5xx на /healthz"
      - "alerts.yaml актуален (SLO не пустые)"
      - "backup_policy.yaml и dr_plan.yaml существуют и не пустые"
      - "alembic upgrade head отрабатывает без ошибок"
