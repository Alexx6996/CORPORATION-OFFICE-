# ADR-001: AIOFFICESSvc service bootstrap

## Статус
Accepted

## Контекст
Бэкенд CORPORATION / OFFICE должен работать как управляемый сервис операционной среды Windows, а не как вручную запущенный процесс разработчика.  
Это нужно для:
- стабильного автозапуска после перезагрузки машины;
- контролируемого окружения выполнения (.venv, зависимости, конфиги);
- изоляции от сети (порт только на loopback);
- наблюдаемости (логи, /health, /metrics);
- аудита (можно подтвердить, какая именно команда запускается в проде).

## Решение
1. Бэкенд CORPORATION / OFFICE развёрнут как Windows-служба `AIOFFICESSvc`.
2. Менеджер службы — NSSM (Non-Sucking Service Manager). NSSM используется для того, чтобы обёрнуть пользовательский процесс uvicorn в управляемый сервис Windows.
3. Старт службы идёт НЕ напрямую через python.exe, а через промежуточный слой `service_launcher.cmd`.  
   Назначение `service_launcher.cmd`:
   - активировать проектное виртуальное окружение `.venv` (Python 3.11 в каталоге C:\work\AICORPORATION\AIOFFICE\.venv);
   - запускать uvicorn именно из этого окружения, а не из любого глобального python.
   Это фиксирует окружение исполнения и запрещает "самодеятельность" админа с левыми интерпретаторами.
4. Uvicorn запускает приложение `apps.backend_core.main:app` и слушает `127.0.0.1:8181`.  
   - Интерфейс `127.0.0.1` (loopback) выбран намеренно: сервис не публикуется во внешнюю сеть.
   - Порт не проброшен наружу через Firewall. Любой внешний доступ должен идти через контролируемый прокси/шлюз, если он вообще разрешён.
5. AIOFFICESSvc перенаправляет stdout/stderr uvicorn в файл логов `observability\aiofficessvc.log`.
   - Лог является частью наблюдаемости.
   - NSSM настраивается так, чтобы обеспечивать ротацию логов.
6. Приложение обязано предоставлять два эндпоинта:
   - `/health` — для статуса жив/не жив;
   - `/metrics` — для Prometheus-метрик и мониторинга.
   Требование: без этих эндпоинтов служба считается не соответствующей эксплуатационному стандарту.

## Эксплуатационные следствия
- Служба `AIOFFICESSvc` должна работать под минимально привилегированным контекстом (например, NT AUTHORITY\LocalService).
- Служба получает права только Read/Execute (RX) на код и .venv через `icacls`. Служба не должна иметь права модифицировать исходники.
- Любые попытки поднять бэкенд вручную в обход `AIOFFICESSvc` (другой порт, другой python, без .venv) считаются нарушением ADR-001.

## Импакт безопасности
- pet-процессы разработчика запрещены; всегда используется формальный путь службы.
- Нет экспонирования uvicorn наружу напрямую.
- Все обращения к сервису снаружи могут быть обёрнуты отдельным reverse proxy с аутентификацией/авторизацией, а ядро остаётся локальным.
- Логи и диагностика попадают в `observability\aiofficessvc.log` и могут быть проверены ретроспективно.

## Вывод
Это ADR фиксирует единственно допустимую модель запуска backend ядра CORPORATION / OFFICE в продовом режиме.  
Если кто-то меняет модель (порт, права, способ запуска, отсутствие /metrics или /health) — он обязан оформить новый ADR и пройти ревью.
## Операционная специфика (добавлено)

1. Запуск службы
   - NSSM зарегистрирован как сервис `AIOFFICESSvc` (AUTO_START).
   - NSSM вызывает `service_launcher.cmd`.
   - `service_launcher.cmd`:
     - пишет отметку запуска в C:\work\AICORPORATION\AIOFFICE\observability\launcher_aiofficessvc.log;
     - активирует окружение .venv проекта;
     - запускает uvicorn на 127.0.0.1:8181;
     - передаёт exit-code uvicorn обратно NSSM.

   Это создаёт трассируемый журнал рестартов (когда NSSM перезапускал сервис).

2. Автовосстановление
   - Настроено поведение NSSM при крэше процесса uvicorn:
     - `nssm.exe set AIOFFICESSvc AppRestartDelay 5000`
   - Это означает, что после аварийного завершения backend перезапускается автоматически через 5 секунд.
   - Цель: непрерывность работы узла без ручного вмешательства.

3. Старт типа AUTO_START
   - Конфигурация службы (sc.exe qc AIOFFICESSvc) показывает:
     - Тип_запуска: AUTO_START (2)
   - Требование эксплуатации: служба должна всегда оставаться в режиме AUTO_START, чтобы ядро CORPORATION / OFFICE поднималось при старте системы.

4. Контекст безопасности
   - Целевое состояние по безопасности: служба должна работать под минимально привилегированной учёткой (например, NT AUTHORITY\LocalService) и иметь только RX-доступ к проекту и .venv.
   - Текущее состояние по факту: служба запущена как LocalSystem.
   - Это считается временным отклонением. Перевод службы на меньшие привилегии и корректные ACL будет выполнен в отдельном шаге hardening.
