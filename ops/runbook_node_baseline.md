# runbook_node_baseline.md
Ревизия: 2025-10-29
Источник фактов: opsreport_operational_baseline_2025-10-29.md, service_profile_aiofficessvc.md

## 1. Назначение узла
Узел CORPORATION / OFFICE — это продовой инстанс AIOFFICESSvc, крутящийся как Windows-служба под NT AUTHORITY\LocalService.
Основной интерфейс оператора — HTTP-эндпоинты сервиса.

## 2. Статусы сервиса
Сервис предоставляет три технических эндпоинта:
- /health
- /ready
- /version

Они используются оператором для диагностики узла без интерактивного входа на хост.

### 2.1 /health
Что проверяет: только жизненность процесса приложения.
Ожидаемое поведение:
- HTTP 200 => процесс сервиса жив.
- Любой другой статус (например 503) => сервис жив физически (порт отвечает), но сообщил, что не в рабочем состоянии. Такое допускается на этапе старта.

Важно: /health НЕ гарантирует, что бекенд готов обрабатывать полезную нагрузку. Это просто "сердце бьётся".

### 2.2 /ready
Что проверяет: готовность узла к приёму трафика.
Требование на Шаге 2:
- /ready должен пинговать Redis (контейнер/инстанс "aioffice-redis").
- Если Redis недоступен — /ready должен возвращать HTTP 503 и JSON с ready=false.

Цель: оператор может понять "сервис жив" (/health 200), но "сервис не готов" (/ready не 200) и не слать нагрузку.

### 2.3 /version
Что возвращает: идентификатор текущей сборки узла.
На Шаге 2:
- версия берётся из version.txt в корне репозитория ИЛИ из git hash, если version.txt отсутствует.
- оператор читает /version удалённо и понимает, какой билд сейчас бежит на ноде, без захода на ноду.

## 3. Утренний запуск узла (start-day)
1. Проверить, что Redis (aioffice-redis) поднят.
2. Запустить службу:
   Start-Service -Name AIOFFICESSvc
3. Проверить состояние службы:
   sc.exe queryex AIOFFICESSvc
   (ожидается RUNNING)
4. Проверить /health:
   Invoke-WebRequest http://127.0.0.1:8181/health
   Ожидаем HTTP 200.
5. Проверить /ready:
   Invoke-WebRequest http://127.0.0.1:8181/ready
   Ожидаем HTTP 200. Если не 200 => проблема зависимостей (например Redis).

6. Запросить /version:
   Invoke-WebRequest http://127.0.0.1:8181/version
   => зафиксировать версию узла в операционном журнале (инвентаризация).

## 4. Вечерняя остановка узла (stop-day)
1. Остановить службу:
   Stop-Service -Name AIOFFICESSvc
2. Остановить Redis (если локальный контейнер/процесс).
3. Зафиксировать в журнале факт штатной остановки.

## 5. Диагностика, если сервис не поднимается
- Если Start-Service падает с "Отказано в доступе" => см. раздел ACL (LocalService должен иметь RX на код, .venv, Python311, и R на HKLM\SYSTEM\CurrentControlSet\Services\AIOFFICESSvc\Parameters).
- Если служба в RUNNING, /health даёт 200, но /ready даёт 503 => смотри Redis.
- Если логи пустые => смотри rotated файлы вида observability\aiofficessvc-<timestamp>.log.

## 6. Контрольная точка продовой ноды
Нода считается "сервис в эксплуатации", когда выполняются ВСЕ условия:
- служба AIOFFICESSvc зарегистрирована через NSSM, бинарь NSSM лежит в ops\nssm\
- служба крутится от NT AUTHORITY\LocalService
- /health отвечает (порт жив)
- /ready сигнализирует про доступность Redis
- /version доступен и читает версию из version.txt (или git hash)
- оператор может пройти п.3 без эскалации прав.

