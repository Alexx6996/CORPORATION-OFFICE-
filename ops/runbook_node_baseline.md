# Runbook: базовая эксплуатация узла CORPORATION / OFFICE

Этот документ описывает минимальный регламент для администратора узла.
Цель: запуск и остановка, проверка состояния, безопасность.
Любые отклонения от этого регламента должны фиксироваться отдельно.

------------------------------------------------------------
1. СТАРТ ДНЯ (выполнять в PowerShell 7 с правами администратора)

Команда:
cd C:\work\AICORPORATION\AIOFFICE; PowerShell -ExecutionPolicy Bypass -File .\ops_routines\start-day.ps1

Ожидаемый результат:
- RESULT: OK - core services are healthy.
- Redis: PONG
- AIOFFICESSvc: Running
- Backend /health: может быть OFF (это не авария, backend может не быть поднят вручную).

Если вместо RESULT: OK показано RESULT: ATTENTION — эскалировать.

------------------------------------------------------------
2. СТОП ДНЯ (выполнять в PowerShell 7 с правами администратора)

Команда:
cd C:\work\AICORPORATION\AIOFFICE; PowerShell -ExecutionPolicy Bypass -File .\ops_routines\stop-day.ps1

Ожидаемый результат:
- Служба AIOFFICESSvc остановлена.
- Контейнер Redis aioffice-redis остановлен.
- RESULT: OK - node is safely shut down.

Если Redis или служба не остановились чисто — зафиксировать и сообщить.

------------------------------------------------------------
3. ПРОВЕРКА СТАТУСА СЛУЖБЫ ВРУЧНУЮ (диагностика, если что-то не так)

Команда:
sc.exe queryex AIOFFICESSvc

Ожидаемое нормальное состояние:
STATE : 4  RUNNING

Если STATE не RUNNING в рабочее время — это инцидент.

------------------------------------------------------------
4. ПРОВЕРКА ЯДРА ВРУЧНУЮ

Назначение:
Проверка живости backend FastAPI через /health на локальном loopback.

Команда:
curl.exe http://127.0.0.1:8181/health

Ожидаемый ответ:
status = ok, HTTP код 200.
Это локальный порт 127.0.0.1:8181. Этот порт не должен быть опубликован наружу.

------------------------------------------------------------
5. ЛОГИ

Текущий лог службы:
C:\work\AICORPORATION\AIOFFICE\observability\aiofficessvc.log

Этот лог пишет служба AIOFFICESSvc через NSSM (stdout/stderr uvicorn).
Если есть проблемы с сервисом, сначала смотреть этот лог.

------------------------------------------------------------
6. БЕЗОПАСНОСТЬ

1) BitLocker:
- Системный диск C: должен быть зашифрован (XtsAes256).
- RecoveryKey сохранён в: C:\Secure\RecoveryKeys\C_recovery.txt

2) Доступ к C:\Secure\RecoveryKeys:
- Только локальные администраторы (SID S-1-5-32-544) и SYSTEM (SID S-1-5-18).
- Запрещено копировать, отправлять или передавать ключ по незащищённым каналам.

3) ACL на службе:
- Служба AIOFFICESSvc запускается под минимально привилегированной учёткой (например, NT AUTHORITY\LocalService).
- Служба имеет только права Read/Execute (RX) на код и виртуальное окружение .venv.
- Служба не имеет прав модифицировать исходный код проекта.

4) Git-политика:
- Файлы с RecoveryKey не коммитим в репозиторий.
- Любой коммит с секретами или ключами считается инцидентом безопасности.

------------------------------------------------------------
7. КОРОТКО
- Утром: start-day.ps1 -> должно быть RESULT: OK.
- Днём: служба AIOFFICESSvc должна быть RUNNING, Redis должен отвечать PONG.
- Вечером: stop-day.ps1 -> должно быть RESULT: OK.
- Лог смотреть в observability\aiofficessvc.log.
- Ключ шифрования диска хранится ТОЛЬКО локально, в git не уходит.
- Порт 8181 наружу не публикуем.

Этот runbook является частью эксплуатационного стандарта узла и обязателен к соблюдению.
