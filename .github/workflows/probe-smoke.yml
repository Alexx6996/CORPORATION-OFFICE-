name: Probe Smoke
on:
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn prometheus-client

      - name: uvicorn (bg) with logs
        shell: pwsh
        run: |
          $env:PYTHONPATH = (Get-Location).Path
          $args = @('-m','uvicorn','apps.backend_core.main:app','--host','127.0.0.1','--port','8181','--log-level','info')
          $p = Start-Process -FilePath python -ArgumentList $args -WorkingDirectory $PWD `
               -RedirectStandardOutput uvicorn.out.log -RedirectStandardError uvicorn.err.log -PassThru
          "Started PID: $($p.Id)"

      - name: Wait for /healthz (up to 45s)
        shell: pwsh
        run: |
          $deadline = (Get-Date).AddSeconds(45)
          $ok = $false
          while((Get-Date) -lt $deadline){
            if (Get-Process -Id $p.Id -ErrorAction SilentlyContinue | Where-Object { $_.HasExited }) {
              Write-Host "uvicorn exited early. stderr tail:"; Get-Content .\uvicorn.err.log -Tail 100
              throw "uvicorn process exited before healthz became 200"
            }
            try {
              $r = Invoke-WebRequest -NoProxy -UseBasicParsing http://127.0.0.1:8181/healthz -TimeoutSec 2
              if($r.StatusCode -eq 200){ $ok = $true; break }
            } catch { Start-Sleep -Milliseconds 500 }
          }
          if(-not $ok){
            Write-Host "uvicorn.out.log tail:"; Get-Content .\uvicorn.out.log -Tail 100
            Write-Host "uvicorn.err.log tail:"; Get-Content .\uvicorn.err.log -Tail 100
            throw "healthz did not become 200 within timeout"
          }

      - name: Probe endpoints
        shell: pwsh
        run: |
          foreach($p in @("/healthz","/health","/ready","/version")){
            $rc = (curl.exe --noproxy "*" -s -o NUL -w "%{http_code}" "http://127.0.0.1:8181$p")
            if($rc -ne "200"){ throw "$p -> $rc" } else { Write-Host "$p -> $rc" }
          }

      - name: Dump logs on failure
        if: ${{ failure() }}
        shell: pwsh
        run: |
          Write-Host "=== uvicorn.out.log (tail) ==="; if(Test-Path .\uvicorn.out.log){ Get-Content .\uvicorn.out.log -Tail 200 }
          Write-Host "=== uvicorn.err.log (tail) ==="; if(Test-Path .\uvicorn.err.log){ Get-Content .\uvicorn.err.log -Tail 200 }
