name: Probe Smoke

on:
    workflow_dispatch:
    pull_request:
    branches: ["*"]
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/probe-smoke.yml"
      - "apps/backend_core/**"

jobs:
  smoke:
    runs-on:
    workflow_dispatch:
    windows-2025
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version:
    workflow_dispatch:
    "3.11"

      - name: Install minimal deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn prometheus-client python-jose[cryptography]

      - name: Run uvicorn and probe /healthz (single step with logs)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $env:PYTHONPATH = (Get-Location).Path
          $args = @(
            '-m','uvicorn','apps.backend_core.main:app',
            '--host','127.0.0.1','--port','8181','--log-level','info'
          )
          $p = Start-Process -FilePath python -ArgumentList $args -WorkingDirectory $PWD `
               -RedirectStandardOutput uvicorn.out.log -RedirectStandardError uvicorn.err.log -PassThru
          "Started PID: $($p.Id)"

          try {
            $deadline = (Get-Date).AddSeconds(60)
            $ok = $false
            while ((Get-Date) -lt $deadline) {
              if ($p.HasExited) {
                Write-Host "uvicorn exited early. stderr tail:"
                if (Test-Path .\uvicorn.err.log) { Get-Content .\uvicorn.err.log -Tail 200 }
                throw "uvicorn process exited before healthz became 200"
              }
              try {
                $r = Invoke-WebRequest -NoProxy -UseBasicParsing http://127.0.0.1:8181/healthz -TimeoutSec 2
                if ($r.StatusCode -eq 200) { $ok = $true; break }
              } catch {
                Start-Sleep -Milliseconds 500
              }
            }

            if (-not $ok) {
              Write-Host "=== uvicorn.out.log (tail) ==="
              if (Test-Path .\uvicorn.out.log) { Get-Content .\uvicorn.out.log -Tail 200 }
              Write-Host "=== uvicorn.err.log (tail) ==="
              if (Test-Path .\uvicorn.err.log) { Get-Content .\uvicorn.err.log -Tail 200 }
              throw "healthz did not become 200 within timeout"
            }

            Write-Host "healthz=200 OK"
          }
          finally {
            if ($p -and -not $p.HasExited) { Stop-Process -Id $p.Id -Force }
          }

