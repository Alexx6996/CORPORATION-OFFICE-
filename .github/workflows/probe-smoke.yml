name: Probe Smoke
on:
  pull_request:
    branches: [ main ]
jobs:
  smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install minimal deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn prometheus-client
      - name: Run uvicorn (bg)
        shell: pwsh
        run: |
          # Запуск в фоне
          $p = Start-Process -FilePath python -ArgumentList '-m','uvicorn','apps.backend_core.main:app','--host','127.0.0.1','--port','8181','--log-level','warning' -PassThru
          "Started PID: $($p.Id)"
      - name: Wait for /healthz (up to 30s)
        shell: pwsh
        run: |
          $deadline = (Get-Date).AddSeconds(30)
          $ok = $false
          while((Get-Date) -lt $deadline){
            try {
              $r = Invoke-WebRequest -NoProxy -UseBasicParsing http://127.0.0.1:8181/healthz -TimeoutSec 2
              if($r.StatusCode -eq 200){ $ok = $true; break }
            } catch { Start-Sleep -Milliseconds 500 }
          }
          if(-not $ok){ throw "healthz did not become 200 within 30s" }
      - name: Curl /healthz
        shell: bash
        run: |
          curl -sS -o /dev/null -w "%{http_code}\n" --noproxy "*" http://127.0.0.1:8181/healthz | grep -q "^200$"
      - name: Curl /ready (allow 200/503)
        shell: bash
        run: |
          code=$(curl -sS -o /dev/null -w "%{http_code}\n" --noproxy "*" http://127.0.0.1:8181/ready)
          if [ "$code" != "200" ] && [ "$code" != "503" ]; then echo "Unexpected code: $code"; exit 1; fi
