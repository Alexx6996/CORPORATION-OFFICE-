# CORPORATION / OFFICE
# start-day.ps1
# Утренний регламент проверки узла.
# ВЫПОЛНЯТЬ: PowerShell 7+ под АДМИН.

Write-Host "=== AIOFFICE START-DAY CHECK ==="

# Timestamp
$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss zzz"
Write-Host "Timestamp: $timestamp"
Write-Host ""

# --- Системная информация ---
try {
    $os = Get-CimInstance Win32_OperatingSystem
    $osVer = $os.Version
    $osCaption = $os.Caption
    $cpuCount = (Get-CimInstance Win32_Processor | Measure-Object -Property NumberOfLogicalProcessors -Sum).Sum
    $memBytes = [int64]$os.TotalVisibleMemorySize * 1024
    Write-Host ("Server: {0} ({1}) | CPUs: {2} | Mem(bytes): {3}" -f $osVer, $osCaption, $cpuCount, $memBytes)
} catch {
    Write-Host "Server: N/A (failed to query system info): $($_.Exception.Message)"
}
Write-Host ""

# --- Redis readiness ---
$redisStatus = "DOWN"
try {
    $redisPing = docker exec aioffice-redis redis-cli ping 2>$null
    if ($redisPing -match "PONG") {
        $redisStatus = "OK"
        Write-Host "Redis: PONG"
    } else {
        $redisStatus = "WARN"
        Write-Host ("Redis: " + $redisPing)
    }
} catch {
    $redisStatus = "ERROR"
    Write-Host ("Redis: ERROR " + $_.Exception.Message)
}
Write-Host ""

# --- Статус службы AIOFFICESSvc ---
$svcStatus = "DOWN"
$svc = Get-Service -Name "AIOFFICESSvc" -ErrorAction SilentlyContinue
if ($null -eq $svc) {
    $svcStatus = "MISSING"
    Write-Host "AIOFFICESSvc: NotFound"
} elseif ($svc.Status -eq "Running") {
    $svcStatus = "OK"
    Write-Host "AIOFFICESSvc: Running"
} else {
    $svcStatus = "WARN"
    Write-Host ("AIOFFICESSvc: " + $svc.Status)
}
Write-Host ""

# --- Кто держит порт 8181 ---
$portOwnerPath = "N/A"
$portOwnerPid = $null
try {
    $conn = Get-NetTCPConnection -LocalPort 8181 -ErrorAction Stop | Select-Object -First 1
    if ($null -ne $conn) {
        $portOwnerPid = $conn.OwningProcess
        $proc = Get-Process -Id $portOwnerPid -ErrorAction SilentlyContinue | Select-Object -First 1 Id,Path
        if ($null -ne $proc) {
            $portOwnerPath = $proc.Path
        }
    }
} catch {
    # порт может быть свободен, это не критическая ошибка
}

Write-Host ("Port 8181 owner PID: {0}" -f ($portOwnerPid ?? "None"))
Write-Host ("Port 8181 owner Path: {0}" -f $portOwnerPath)
Write-Host ""

# --- /version ---
$versionCode = "OFF"
$versionBody = "n/a"
try {
    $respVersion = Invoke-WebRequest -UseBasicParsing -Uri "http://127.0.0.1:8181/version" -TimeoutSec 2
    $versionCode = $respVersion.StatusCode
    $versionBody = $respVersion.Content.Trim()
} catch {
    $versionCode = "ERR"
    $versionBody = $_.Exception.Message
}
Write-Host ("/version: {0} {1}" -f $versionCode, $versionBody)
Write-Host ""

# --- /ready ---
$readyCode = "OFF"
$readyBody = "n/a"
try {
    $respReady = Invoke-WebRequest -UseBasicParsing -Uri "http://127.0.0.1:8181/ready" -TimeoutSec 2
    $readyCode = $respReady.StatusCode
    $readyBody = $respReady.Content.Trim()
} catch {
    $readyCode = "ERR"
    $readyBody = $_.Exception.Message
}
Write-Host ("/ready: {0} {1}" -f $readyCode, $readyBody)
Write-Host ""

# --- Итоговый RESULT ---
# Логика:
# - узел считается в норме для эксплуатации, если:
#   1) служба RUNNING,
#   2) порт 8181 держит .venv\Scripts\python.exe,
#   3) /version отвечает 200.
$ownerOk = ($portOwnerPath -like "*\AIOFFICE\.venv\Scripts\python.exe")
$svcOk = ($svcStatus -eq "OK")
$versionOk = ($versionCode -eq 200)

if ($ownerOk -and $svcOk -and $versionOk) {
    Write-Host "RESULT: OK - node is clean and identified."
} else {
    Write-Host "RESULT: ATTENTION - manual review required."
}

Write-Host ""
Write-Host "start-day done"
